<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

    <!-- Vega Lite -->
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>

    <title>Reflect On Your Health</title>
    <link rel="stylesheet" href="styles.css" />

    <!-- Shared theme: colors, fonts, type scale -->
    <style type="text/tailwindcss">
        @theme {
            --color-dark-blue: #1A3447;
            --color-espresso: #362822;
            --color-coffee: #F0C376;
            --color-cream: #FAEDD6;

            --font-helvetica: "Helvetica";
            --font-calibri: "Calibri";

            /* Display headings */
            --text-display-sm: 2.75rem;
            --text-display-md: 4rem;
            --text-display-lg: 6rem;

            /* Subheadings / links */
            --text-link-sm: 1.125rem;
            --text-link-md: 1.5rem;
            --text-link-lg: 2rem;

            /* Body text */
            --text-body: 1rem;
            --text-small: 0.875rem;
        }
    </style>
</head>

<body class="bg-white">

    <!-- Navigation -->
    <nav class="w-full flex justify-between items-center py-6 px-6 md:px-10 border-b border-gray-300">
        <div class="flex space-x-6 md:space-x-10">
            <span class="font-helvetica text-small md:text-body" style="color:#362822;">
                IAT 355 (Fall 2025)
            </span>
            <span class="font-helvetica text-small md:text-body" style="color:#362822;">
                Caffeine Mugs
            </span>
        </div>

        <a href="index.html"
            class="px-4 py-2 rounded-lg font-helvetica text-small md:text-body hover:bg-[#F2E2C8] transition"
            style="background-color:#F8EBD8; color:#362822;">
            Home
        </a>
    </nav>

    <!-- Main content -->
    <main class="bg-white w-full py-[72px] md:py-[90px] lg:py-[101px] px-6 md:px-[70px] lg:px-[90px]">

        <!-- Back to home icon -->
        <a href="index.html" class="inline-flex items-center mb-8">
            <img src="src/back-arrow.svg" alt="Back to home" class="w-6 h-6 md:w-7 md:h-7">
        </a>

        <!-- Hero section: title + illustration -->
        <section class="grid grid-cols-1 lg:grid-cols-12 gap-8 lg:gap-16 items-center mt-4 lg:mt-10">
            <!-- Left text -->
            <div class="lg:col-span-7 lg:pr-[4vw]">
                <h1
                    class="font-helvetica font-thin text-display-sm md:text-display-md lg:text-display-md text-espresso mb-4 max-w-[16ch]">
                    Reflect On Your Health
                </h1>
                <p class="font-calibri text-body text-espresso leading-relaxed max-w-[40rem]">
                    Now it is time to reflect on what you have learned about caffeine and your health.
                    Use the dashboard below to enter how many cups of coffee you drink per day
                    and how many hours you usually sleep. You will see how your patterns compare
                    to the people in our dataset.
                </p>
            </div>

            <!-- Right illustration -->
            <div class="lg:col-span-5 flex justify-center lg:justify-end mt-8 lg:mt-0">
                <img src="src/drinking-coffee.svg" alt="Person drinking coffee"
                    class="w-48 md:w-56 lg:w-[22rem] max-w-full">
            </div>
        </section>

        <!-- Input + Result dashboard -->
        <section class="w-full mt-16 max-w-6xl mx-auto">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">

                <!-- Left: Input card -->
                <div class="rounded-3xl border border-[#E5D2B5] bg-[#FFF9EF] p-8 shadow-sm">
                    <h2 class="font-helvetica font-semibold text-link-sm md:text-link-md text-espresso mb-4">
                        Enter your daily habits
                    </h2>

                    <form id="healthForm" class="space-y-6" onsubmit="event.preventDefault(); analyzeHealth();">
                        <!-- Gender -->
                        <div>
                            <label for="genderInput" class="block text-small font-helvetica text-espresso mb-2">
                                Gender
                            </label>
                            <select id="genderInput"
                                class="w-full border border-gray-300 rounded-xl px-4 py-2 text-small font-helvetica focus:outline-none focus:ring-2 focus:ring-[#E9C98F]">
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <!-- Age -->
                        <div>
                            <label for="ageInput" class="block text-small font-helvetica text-espresso mb-2">
                                Age
                            </label>
                            <input id="ageInput" type="number" min="15" max="90" step="1" placeholder="For example 26"
                                class="w-full border border-gray-300 rounded-xl px-4 py-2 text-small font-helvetica focus:outline-none focus:ring-2 focus:ring-[#E9C98F]">
                        </div>

                        <!-- Coffee intake -->
                        <div>
                            <label for="coffeeInput" class="block text-small font-helvetica text-espresso mb-2">
                                Cups of coffee per day
                            </label>
                            <input id="coffeeInput" type="number" min="0" max="15" step="0.1"
                                placeholder="For example 2.5"
                                class="w-full border border-gray-300 rounded-xl px-4 py-2 text-small font-helvetica focus:outline-none focus:ring-2 focus:ring-[#E9C98F]">
                        </div>

                        <!-- Sleep hours -->
                        <div>
                            <label for="sleepInput" class="block text-small font-helvetica text-espresso mb-2">
                                Sleep hours per night
                            </label>
                            <input id="sleepInput" type="number" min="0" max="14" step="0.1"
                                placeholder="For example 7.0"
                                class="w-full border border-gray-300 rounded-xl px-4 py-2 text-small font-helvetica focus:outline-none focus:ring-2 focus:ring-[#E9C98F]">
                        </div>

                        <!-- Stress level -->
                        <div>
                            <label for="stressInput" class="block text-small font-helvetica text-espresso mb-2">
                                Stress level (1–10, self rated)
                            </label>
                            <input id="stressInput" type="number" min="1" max="10" step="1" placeholder="For example 7"
                                class="w-full border border-gray-300 rounded-xl px-4 py-2 text-small font-helvetica focus:outline-none focus:ring-2 focus:ring-[#E9C98F]">
                        </div>

                        <button type="submit"
                            class="mt-4 inline-flex items-center justify-center rounded-[25px] px-8 py-3 bg-[#1E2E3E] text-white text-button font-helvetica transition-all duration-300 hover:shadow-[-6px_6px_0_#E9C98F] active:bg-[#E9C98F] active:text-[#362822] active:border active:border-[#4A2B18] active:shadow-none active:scale-95">
                            Reflect with the dataset
                        </button>
                    </form>
                </div>

                <!-- Right: Result card -->
                <div id="resultCard"
                    class="rounded-3xl border border-[#E5D2B5] bg-white p-8 shadow-sm flex flex-col justify-between">
                    <div>
                        <h2 class="font-helvetica font-semibold text-link-sm md:text-link-md text-espresso mb-4">
                            Your Health Predictor
                        </h2>

                        <p id="loadingMessage" class="text-small md:text-body font-helvetica text-gray-500 mb-6">
                            Enter your information on the left and see how you compare to our research.
                        </p>

                        <div id="vizContainer" class="space-y-8 hidden">
                            <!-- Legend -->
                            <div class="flex items-center space-x-6 mb-6">
                                <div class="flex items-center space-x-3">
                                    <img src="src/coffeeBean_You.svg" alt="You legend" class="h-5 w-auto">
                                    <span class="text-small font-helvetica text-espresso">You</span>
                                </div>

                                <div class="flex items-center space-x-3">
                                    <img src="src/coffeeBean_Avg.svg" alt="Average legend" class="h-5 w-auto">
                                    <span class="text-small font-helvetica text-espresso">Group average</span>
                                </div>
                            </div>

                            <p id="summaryText"
                                class="text-small md:text-body font-helvetica text-espresso leading-relaxed"></p>

                            <!-- Coffee bar -->
                            <div class="space-y-2">
                                <div class="flex justify-between items-baseline">
                                    <span class="text-small font-helvetica text-espresso">
                                        Daily coffee intake
                                    </span>
                                    <span id="coffeeLabel" class="text-xs font-helvetica text-gray-500"></span>
                                </div>

                                <!-- Outer wrapper controlling bar + beans -->
                                <div class="relative h-10">
                                    <!-- Bar background -->
                                    <div
                                        class="absolute inset-x-0 bottom-0 h-4 rounded-full bg-[#F2E2C8] overflow-hidden">
                                    </div>

                                    <!-- User position bean -->
                                    <div id="coffeeYouWrap" class="absolute flex flex-col items-center z-10"
                                        style="top:-2px; left:50%; transform:translateX(-50%);">
                                        <span class="text-[10px] font-helvetica text-[#1E2E3E] mb-1">You</span>
                                        <img id="coffeeYou" src="src/coffeeBean_You.svg" alt="You indicator"
                                            class="h-5 w-auto">
                                    </div>

                                    <!-- Average position bean -->
                                    <div id="coffeeAvgWrap" class="absolute flex flex-col items-center z-10"
                                        style="top:-2px; left:60%; transform:translateX(-50%);">
                                        <span class="text-[10px] font-helvetica text-[#362822] mb-1">Avg</span>
                                        <img id="coffeeAvg" src="src/coffeeBean_Avg.svg" alt="Average indicator"
                                            class="h-5 w-auto">
                                    </div>
                                </div>

                                <div class="flex justify-between text-[11px] font-helvetica text-gray-500">
                                    <span>Lower intake</span>
                                    <span>Higher intake</span>
                                </div>
                            </div>

                            <!-- Sleep bar -->
                            <div class="space-y-2">
                                <div class="flex justify-between items-baseline">
                                    <span class="text-small font-helvetica text-espresso">
                                        Sleep hours per night
                                    </span>
                                    <span id="sleepLabel" class="text-xs font-helvetica text-gray-500"></span>
                                </div>

                                <!-- Outer wrapper -->
                                <div class="relative h-10">
                                    <!-- Bar background -->
                                    <div
                                        class="absolute inset-x-0 bottom-0 h-4 rounded-full bg-[#F2E2C8] overflow-hidden">
                                    </div>

                                    <!-- User position bean -->
                                    <div id="sleepYouWrap" class="absolute flex flex-col items-center z-10"
                                        style="top:-2px; left:50%; transform:translateX(-50%);">
                                        <span class="text-[10px] font-helvetica text-[#1E2E3E] mb-1">You</span>
                                        <img id="sleepYou" src="src/coffeeBean_You.svg" alt="You indicator"
                                            class="h-5 w-auto">
                                    </div>

                                    <!-- Average position bean -->
                                    <div id="sleepAvgWrap" class="absolute flex flex-col items-center z-10"
                                        style="top:-2px; left:60%; transform:translateX(-50%);">
                                        <span class="text-[10px] font-helvetica text-[#362822] mb-1">Avg</span>
                                        <img id="sleepAvg" src="src/coffeeBean_Avg.svg" alt="Average indicator"
                                            class="h-5 w-auto">
                                    </div>
                                </div>

                                <div class="flex justify-between text-[11px] font-helvetica text-gray-500">
                                    <span>Less sleep</span>
                                    <span>More sleep</span>
                                </div>
                            </div>

                            <!-- Stress bar -->
                            <div class="space-y-2">
                                <div class="flex justify-between items-baseline">
                                    <span class="text-small font-helvetica text-espresso">
                                        Stress level (self rated)
                                    </span>
                                    <span id="stressLabel" class="text-xs font-helvetica text-gray-500"></span>
                                </div>

                                <!-- Wrapper for bar + bean -->
                                <div class="relative h-10">
                                    <!-- Bar background with segments -->
                                    <div
                                        class="absolute inset-x-0 bottom-0 h-4 rounded-full bg-[#F2E2C8] overflow-hidden">
                                        <div class="absolute inset-y-0 left-0 w-1/3 border-r border-white/60"></div>
                                        <div class="absolute inset-y-0 left-1/3 w-1/3 border-r border-white/60"></div>
                                    </div>

                                    <!-- Bean indicator -->
                                    <div id="stressYouWrap" class="absolute flex flex-col items-center z-10"
                                        style="top:-2px; left:50%; transform:translateX(-50%);">
                                        <span class="text-[10px] font-helvetica text-[#1E2E3E] mb-1">You</span>
                                        <img id="stressYou" src="src/coffeeBean_You.svg" alt="You indicator"
                                            class="h-5 w-auto">
                                    </div>
                                </div>

                                <div class="flex justify-between text-[11px] font-helvetica text-gray-500">
                                    <span>Low</span>
                                    <span>Medium</span>
                                    <span>High</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <p class="mt-6 text-[11px] md:text-xs font-helvetica text-gray-500">
                        Disclaimer: This dashboard is for personal reflection only. It is based on patterns from
                        Caffeine Mugs’ caffeine and health datasets and research, and does not provide medical advice.
                    </p>
                </div>

            </div>
        </section>

        <!-- Back to Home button -->
        <div class="mt-16 flex justify-center items-center">
            <a href="index.html"
                class="inline-flex items-center justify-center relative rounded-[25px] px-12 py-6 bg-[#1E2E3E] text-white text-button font-helvetica transition-all duration-300 hover:shadow-[-8px_8px_0_#E9C98F] active:bg-[#E9C98F] active:text-[#362822] active:border active:border-[#4A2B18] active:shadow-none active:scale-95">
                Back to Home
            </a>
        </div>

    </main>

    <!-- Tooltip (used by JS) -->
    <div id="tooltip"
        class="absolute px-2 py-1 text-xs font-helvetica bg-[#362822] text-white rounded hidden pointer-events-none"
        style="z-index:999; transform:translate(-50%, -120%);">
    </div>

    <!-- Main JS for charts -->
    <script src="main.js"></script>

    <!-- Page-specific JS -->
    <script>
        let caffeineData = [];
        let dataLoaded = false;

        // Read caffeine.csv
        fetch("caffeine.csv")
            .then(response => response.text())
            .then(text => {
                const lines = text.trim().split("\n");
                const headers = lines[0].split(",");
                caffeineData = lines.slice(1).map(line => {
                    const values = line.split(",");
                    const row = {};
                    headers.forEach((h, i) => {
                        const key = h.trim();
                        const value = values[i] ? values[i].trim() : "";
                        const num = Number(value);
                        row[key] = isNaN(num) ? value : num;
                    });
                    return row;
                });

                dataLoaded = true;
                document.getElementById("loadingMessage").innerText =
                    "Enter your information on the left and see how you compare to our research.";
            })
            .catch(err => {
                console.error(err);
                document.getElementById("loadingMessage").innerText =
                    "Could not load the dataset. Please check the file path.";
            });

        // Percentile helper
        function getPercentile(values, x) {
            const filtered = values.filter(v => typeof v === "number" && !isNaN(v));
            if (!filtered.length) return null;
            filtered.sort((a, b) => a - b);
            const count = filtered.filter(v => v <= x).length;
            return Math.round((count / filtered.length) * 100);
        }

        // Map numeric value to 0–100% left position
        function getPosition(values, x) {
            const filtered = values.filter(v => typeof v === "number" && !isNaN(v));
            if (!filtered.length) return 50;
            const min = Math.min(...filtered);
            const max = Math.max(...filtered);
            if (max === min) return 50;
            const t = (x - min) / (max - min);
            return Math.max(0, Math.min(100, t * 100));
        }

        // Map dataset stress levels (Low/Medium/High) to numeric scores
        function levelToScore(level) {
            if (level === "Low") return 3;
            if (level === "Medium") return 6;
            if (level === "High") return 9;
            return 6;
        }

        // Map a 1–10 stress score to a 0–100 position
        function stressScoreToPos(score) {
            if (isNaN(score)) return 50;
            const t = (score - 1) / 9;
            return Math.max(0, Math.min(100, t * 100));
        }

        // Tooltip base
        const tooltip = document.getElementById("tooltip");

        function attachTooltip(targetId, text) {
            const target = document.getElementById(targetId);
            if (!target) return;
            const wrapper = target.parentElement;
            if (!wrapper) return;

            // Store text for later updates
            wrapper.dataset.tooltipText = text;

            // Avoid binding multiple listeners
            if (wrapper.dataset.tooltipAttached === "true") {
                return;
            }
            wrapper.dataset.tooltipAttached = "true";

            wrapper.addEventListener("mouseenter", () => {
                tooltip.innerText = wrapper.dataset.tooltipText || "";
                tooltip.classList.remove("hidden");
            });

            wrapper.addEventListener("mouseleave", () => {
                tooltip.classList.add("hidden");
            });

            wrapper.addEventListener("mousemove", (e) => {
                tooltip.style.left = e.pageX + "px";
                tooltip.style.top = e.pageY + "px";
                tooltip.innerText = wrapper.dataset.tooltipText || "";
            });
        }

        function analyzeHealth() {
            if (!dataLoaded) {
                alert("Dataset is still loading. Please try again in a moment.");
                return;
            }

            const gender = document.getElementById("genderInput").value;
            const age = Number(document.getElementById("ageInput").value);
            const cups = Number(document.getElementById("coffeeInput").value);
            const sleep = Number(document.getElementById("sleepInput").value);
            const stressScore = Number(document.getElementById("stressInput").value);

            if (!age || isNaN(cups) || isNaN(sleep) || isNaN(stressScore)) {
                alert("Please fill in age, coffee intake, sleep hours, and stress level.");
                return;
            }

            // Base group: full dataset or same-gender subset
            let group = caffeineData;
            if (gender) {
                const filtered = caffeineData.filter(d => d.Gender === gender);
                if (filtered.length > 30) {
                    group = filtered;
                }
            }

            const intakeValues = group.map(d => d.Coffee_Intake);
            const sleepValues = group.map(d => d.Sleep_Hours);

            const coffeePct = getPercentile(intakeValues, cups);
            const sleepPct = getPercentile(sleepValues, sleep);

            const avgCoffee = intakeValues.reduce((a, b) => a + b, 0) / intakeValues.length;
            const avgSleep = sleepValues.reduce((a, b) => a + b, 0) / sleepValues.length;

            // Summary text
            const summaryParts = [];
            summaryParts.push(
                `You are ${age} years old and reported ${cups.toFixed(1)} cups of coffee per day with ${sleep.toFixed(1)} hours of sleep.`
            );
            if (gender) {
                summaryParts.push(
                    `The visualisation uses people of the same gender when there are enough records, otherwise it uses the full dataset.`
                );
            } else {
                summaryParts.push(`The visualisation uses the full dataset.`);
            }
            document.getElementById("summaryText").innerText = summaryParts.join(" ");

            // Coffee position + label
            const coffeePosYou = getPosition(intakeValues, cups);
            const coffeePosAvg = getPosition(intakeValues, avgCoffee);
            document.getElementById("coffeeYouWrap").style.left = coffeePosYou + "%";
            document.getElementById("coffeeAvgWrap").style.left = coffeePosAvg + "%";

            const coffeeLabelText = coffeePct != null
                ? `${cups.toFixed(1)} cups • higher than about ${coffeePct}% of this group`
                : `${cups.toFixed(1)} cups`;
            document.getElementById("coffeeLabel").innerText = coffeeLabelText;

            // Sleep position + label
            const sleepPosYou = getPosition(sleepValues, sleep);
            const sleepPosAvg = getPosition(sleepValues, avgSleep);
            document.getElementById("sleepYouWrap").style.left = sleepPosYou + "%";
            document.getElementById("sleepAvgWrap").style.left = sleepPosAvg + "%";

            const sleepLabelText = sleepPct != null
                ? `${sleep.toFixed(1)} hours • higher than about ${sleepPct}% of this group`
                : `${sleep.toFixed(1)} hours`;
            document.getElementById("sleepLabel").innerText = sleepLabelText;

            // Stress: compare within similar coffee intake group (±1 cup)
            const similarCoffeeGroup = group.filter(d =>
                typeof d.Coffee_Intake === "number" &&
                !isNaN(d.Coffee_Intake) &&
                Math.abs(d.Coffee_Intake - cups) <= 1
            );
            const stressGroup = similarCoffeeGroup.length >= 30 ? similarCoffeeGroup : group;

            const stressValues = stressGroup
                .map(d => levelToScore(d.Stress_Level))
                .filter(v => typeof v === "number" && !isNaN(v));

            let stressLabel = "";
            let stressComparison = "";

            if (stressValues.length > 0) {
                const avgStress = stressValues.reduce((a, b) => a + b, 0) / stressValues.length;
                const stressPct = getPercentile(stressValues, stressScore);

                if (stressPct > 66) {
                    stressComparison = "higher than most people with a similar coffee intake";
                } else if (stressPct < 33) {
                    stressComparison = "lower than many people with a similar coffee intake";
                } else {
                    stressComparison = "similar to most people with a similar coffee intake";
                }

                stressLabel =
                    `You rated ${stressScore}/10 • your stress is ${stressComparison}.`;
            } else {
                stressLabel = `You rated ${stressScore}/10 • we could not find enough similar records to compare.`;
            }

            // Stress position + label
            const stressPos = stressScoreToPos(stressScore);
            document.getElementById("stressYouWrap").style.left = stressPos + "%";
            document.getElementById("stressLabel").innerText = stressLabel;

            // Tooltips
            if (coffeePct != null) {
                attachTooltip("coffeeYou", `${coffeePct}% of people drink less than or equal to you`);
            } else {
                attachTooltip("coffeeYou", `Your coffee intake: ${cups.toFixed(1)} cups/day`);
            }
            attachTooltip("coffeeAvg", `Group average: ${avgCoffee.toFixed(1)} cups/day`);

            if (sleepPct != null) {
                attachTooltip("sleepYou", `${sleepPct}% of people sleep less than or equal to you`);
            } else {
                attachTooltip("sleepYou", `Your sleep: ${sleep.toFixed(1)} hours`);
            }
            attachTooltip("sleepAvg", `Group average: ${avgSleep.toFixed(1)} hours`);

            attachTooltip("stressYou", `Your stress: ${stressScore}/10${stressComparison ? " • " + stressComparison : ""}`);

            // Reveal visualisation
            document.getElementById("loadingMessage").classList.add("hidden");
            document.getElementById("vizContainer").classList.remove("hidden");
        }
    </script>

    <!-- Footer -->
    <footer
        class="w-full py-10 px-6 md:px-20 lg:px-28 mt-20 font-calibri text-[#362822] bg-[#F8EBD8] text-small md:text-body">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 md:gap-10">

            <!-- Design -->
            <div>
                <h3 class="font-semibold text-body mb-3">Design</h3>
                <p class="font-normal mb-1">Jasmine Bamba</p>
                <p class="font-normal">Sienna Wu</p>
            </div>

            <!-- Developer -->
            <div>
                <h3 class="font-semibold text-body mb-3">Developer</h3>
                <p class="font-normal mb-1">Elizabeth Liao</p>
                <p class="font-normal">Sienna Wu</p>
            </div>

            <!-- Info block -->
            <div class="text-left md:text-right">
                <h3 class="font-semibold text-body mb-3">
                    IAT 355 (Fall 2025) | Final Project
                </h3>
                <p class="font-normal">© 2025 Caffeine Mugs</p>
            </div>

        </div>
    </footer>

</body>

</html>